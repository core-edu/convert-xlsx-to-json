<!-- This code was based on https://stackoverflow.com/questions/28782074/excel-to-json-javascript-code -->

<input type="file" id="my_file_input" />
<div id='my_file_output'></div>
<div id="container"></div>

<script type="text/javascript" src="node_modules\xlsx-style\dist\xlsx.core.min.js"></script>
<script type="text/javascript" src="node_modules\jquery\dist\jquery.min.js"></script>
<script type="text/javascript">
    var oFileIn;

    $(function () {
        oFileIn = document.getElementById('my_file_input');
        if (oFileIn.addEventListener) {
            oFileIn.addEventListener('change', filePicked, false);
        }
    });


    function filePicked(oEvent) {
        // Get The File From The Input
        var oFile = oEvent.target.files[0];
        var sFilename = oFile.name;
        // Create A File Reader HTML5
        var reader = new FileReader();


        // Ready The Event For When A File Gets Selected
        reader.onload = function (e) {
            var users = { list: [] };
            var data = e.target.result;
            var cfb = XLSX.read(data, { type: 'binary' });
            console.log(cfb)
            cfb.SheetNames.forEach(function (sheetName) {
                // Obtain The Current Row As CSV
                var sCSV = XLS.utils.make_csv(cfb.Sheets[sheetName]);
                var oJS = XLS.utils.sheet_to_json(cfb.Sheets[sheetName]);

                oJS = cleanValues(oJS);

                var newUsers = [];
                newUsers.push.apply(users.list, oJS)

                console.log(oJS);
            });

            const usersJson = JSON.stringify(users);

            $.post("/users", { usersJson }, function (result) {
                $("span").html(result);
                downloadObjectAsJson(users, "data.json");
            });
        };

        // Tell JS To Start Reading The File.. You could delay this if desired
        reader.readAsBinaryString(oFile);
    }

    function cleanValues(list) {
        list.map((object) => {
            Object.keys(object).map((key) => {
                object[key] = object[key].replace(key + ': ', '');
            });
        });

        return list;
    }

    function downloadObjectAsJson(exportObj, exportName) {
        var data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));

        var a = document.createElement('a');
        a.href = 'data:' + data;
        a.download = exportName;
        a.innerHTML = 'download JSON';

        var container = document.getElementById('container');
        container.appendChild(a);
    }
</script>